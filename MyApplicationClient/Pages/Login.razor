@page "/login"
@using MyApplicationServiceLayer.Authenticate.Login.Models;
@inject IAccountService AccountService;

<fieldset disabled="@(userName is not null)">
    <EditForm Model="@model" OnValidSubmit="Submit">
        <div>
            <label>Username:</label>
            <InputText @bind-Value="@model.UserName" requried/>
        </div>
        <div>
            <label>Password:</label>
            <InputText type="password" @bind-Value="@model.Password" required></InputText>
        </div>
        <div>
            <button type="submit">Login</button>
        </div>
    </EditForm>
</fieldset>

@code {
    private LoginModel model = new LoginModel();
    string? userName;
    string? errorMessage;

    private async Task Submit()
    {
        try
        {
            await AccountService.Login(model);
        }
        catch(Exception ex)
        {
            errorMessage = ex.Message;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        var jwt = await AccountService.GetJwt();

        if (string.IsNullOrEmpty(jwt)) userName = null;

        AccountService.LoginChange += (name, role) =>
        {
            userName = name;

            StateHasChanged();

        };
    }
}
